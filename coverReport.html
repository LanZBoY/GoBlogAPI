
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>appinit: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">wentee/blog/app/appinit/mongo.go (0.0%)</option>
				
				<option value="file1">wentee/blog/app/config/environment.go (0.0%)</option>
				
				<option value="file2">wentee/blog/app/di/container.go (0.0%)</option>
				
				<option value="file3">wentee/blog/app/docs/docs.go (0.0%)</option>
				
				<option value="file4">wentee/blog/app/handler/auth/auth.go (0.0%)</option>
				
				<option value="file5">wentee/blog/app/handler/post/post.go (0.0%)</option>
				
				<option value="file6">wentee/blog/app/handler/user/user.go (0.0%)</option>
				
				<option value="file7">wentee/blog/app/main.go (0.0%)</option>
				
				<option value="file8">wentee/blog/app/middleware/auth.go (0.0%)</option>
				
				<option value="file9">wentee/blog/app/middleware/error.go (0.0%)</option>
				
				<option value="file10">wentee/blog/app/repo/post/post_impl.go (100.0%)</option>
				
				<option value="file11">wentee/blog/app/repo/post/post_interface.go (0.0%)</option>
				
				<option value="file12">wentee/blog/app/repo/post/utils.go (100.0%)</option>
				
				<option value="file13">wentee/blog/app/repo/user/user_impl.go (100.0%)</option>
				
				<option value="file14">wentee/blog/app/repo/user/user_interface.go (0.0%)</option>
				
				<option value="file15">wentee/blog/app/routes/routes.go (0.0%)</option>
				
				<option value="file16">wentee/blog/app/routes/v1/auth.go (0.0%)</option>
				
				<option value="file17">wentee/blog/app/routes/v1/post.go (0.0%)</option>
				
				<option value="file18">wentee/blog/app/routes/v1/user.go (0.0%)</option>
				
				<option value="file19">wentee/blog/app/schema/apperror/apperror.go (0.0%)</option>
				
				<option value="file20">wentee/blog/app/schema/apperror/errcode/error_code.go (0.0%)</option>
				
				<option value="file21">wentee/blog/app/schema/basemodel/base.go (0.0%)</option>
				
				<option value="file22">wentee/blog/app/services/auth/auth.go (0.0%)</option>
				
				<option value="file23">wentee/blog/app/services/post/post_impl.go (0.0%)</option>
				
				<option value="file24">wentee/blog/app/services/user/user_impl.go (0.0%)</option>
				
				<option value="file25">wentee/blog/app/testutils/mongo_utils.go (0.0%)</option>
				
				<option value="file26">wentee/blog/app/utils/mongo/mongoutils/count.go (0.0%)</option>
				
				<option value="file27">wentee/blog/app/utils/mongo/pipefactory/pipeline_factory.go (0.0%)</option>
				
				<option value="file28">wentee/blog/app/utils/reqcontext/context_key.go (0.0%)</option>
				
				<option value="file29">wentee/blog/app/utils/security.go (0.0%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package appinit

import (
        "context"
        "time"

        "go.mongodb.org/mongo-driver/mongo"
        "go.mongodb.org/mongo-driver/mongo/options"
)

func GetMongoClient(opt *options.ClientOptions) *mongo.Client <span class="cov0" title="0">{
        ctx, cancel := context.WithTimeout(context.Background(), 20*time.Second)
        defer cancel()

        client, err := mongo.Connect(ctx, opt)

        if err != nil </span><span class="cov0" title="0">{
                panic("Mongo Connection Error!")</span>
        }

        <span class="cov0" title="0">return client</span>
}
</pre>
		
		<pre class="file" id="file1" style="display: none">package config

import "os"

var (
        SERVICE_NAME   string
        MONGO_URI      string
        MOGNO_DATABASE string
        JWT_SECRET     string
)

func init() <span class="cov0" title="0">{
        SERVICE_NAME = getEnvOrDefault("SERVICE_NAME", "App")
        MONGO_URI = getEnvOrDefault("MONGO_URI", "mongodb://localhost:27017")
        MOGNO_DATABASE = getEnvOrDefault("MOGNO_DATABASE", "Blog_Default")
        JWT_SECRET = getEnvOrDefault("JWT_SECRET", "RadomString")
}</span>

func getEnvOrDefault(env_key, default_value string) string <span class="cov0" title="0">{

        if v := os.Getenv(env_key); v != "" </span><span class="cov0" title="0">{
                return v
        }</span>

        <span class="cov0" title="0">return default_value</span>
}
</pre>
		
		<pre class="file" id="file2" style="display: none">package di

import (
        "wentee/blog/app/appinit"
        "wentee/blog/app/config"
        AuthRouter "wentee/blog/app/handler/auth"
        PostRouter "wentee/blog/app/handler/post"
        UserRouter "wentee/blog/app/handler/user"
        "wentee/blog/app/repo"
        PostRepo "wentee/blog/app/repo/post"
        UserRepo "wentee/blog/app/repo/user"
        AuthSvc "wentee/blog/app/services/auth"
        PostSvc "wentee/blog/app/services/post"
        UserService "wentee/blog/app/services/user"
        "wentee/blog/app/utils/mongo/mongoutils"
)

type Container struct {
        UserRouter *UserRouter.UserRouter
        AuthRouter *AuthRouter.AuthRouter
        PostRouter *PostRouter.PostRouter
}

func InitContainer(appCtx *appinit.AppContext) *Container <span class="cov0" title="0">{
        mainDB := appCtx.MongoClient.Database(config.MOGNO_DATABASE)
        docCounter := &amp;mongoutils.MongoUtils{}

        userRepo := UserRepo.NewUserRepo(&amp;UserRepo.UserCollectionAdapter{Collection: mainDB.Collection(repo.UserCollection)})
        userSvc := UserService.NewUserService(userRepo)
        userRouter := UserRouter.NewUserRouter(userSvc)

        authSvc := AuthSvc.NewAuthService(userRepo)
        authRouter := AuthRouter.NewAuthRouter(authSvc)

        poseRepo := PostRepo.NewPostRepo(&amp;PostRepo.PostCollectionAdapter{Collection: mainDB.Collection(repo.PostCollection)}, docCounter)
        postSvc := PostSvc.NewPostService(poseRepo)
        postRouter := PostRouter.NewPostRouter(postSvc)

        return &amp;Container{
                UserRouter: userRouter,
                AuthRouter: authRouter,
                PostRouter: postRouter,
        }
}</span>
</pre>
		
		<pre class="file" id="file3" style="display: none">// Package docs Code generated by swaggo/swag. DO NOT EDIT
package docs

import "github.com/swaggo/swag"

const docTemplate = `{
    "schemes": {{ marshal .Schemes }},
    "swagger": "2.0",
    "info": {
        "description": "{{escape .Description}}",
        "title": "{{.Title}}",
        "contact": {},
        "version": "{{.Version}}"
    },
    "host": "{{.Host}}",
    "basePath": "{{.BasePath}}",
    "paths": {
        "/auth/login": {
            "post": {
                "consumes": [
                    "application/json"
                ],
                "produces": [
                    "application/json"
                ],
                "tags": [
                    "Auth"
                ],
                "summary": "登入API",
                "parameters": [
                    {
                        "description": "登入資訊",
                        "name": "loginInfo",
                        "in": "body",
                        "required": true,
                        "schema": {
                            "$ref": "#/definitions/auth.LoginInfo"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "OK",
                        "schema": {
                            "allOf": [
                                {
                                    "$ref": "#/definitions/basemodel.BaseResponse"
                                },
                                {
                                    "type": "object",
                                    "properties": {
                                        "data": {
                                            "$ref": "#/definitions/auth.TokenResponse"
                                        }
                                    }
                                }
                            ]
                        }
                    }
                }
            }
        },
        "/posts": {
            "get": {
                "security": [
                    {
                        "BasicAuth": []
                    }
                ],
                "description": "取得貼文列表",
                "consumes": [
                    "application/json"
                ],
                "produces": [
                    "application/json"
                ],
                "tags": [
                    "Post"
                ],
                "summary": "貼文列表",
                "responses": {
                    "200": {
                        "description": "OK",
                        "schema": {
                            "allOf": [
                                {
                                    "$ref": "#/definitions/basemodel.BaseListResponse"
                                },
                                {
                                    "type": "object",
                                    "properties": {
                                        " data": {
                                            "type": "array",
                                            "items": {
                                                "$ref": "#/definitions/post.PostList"
                                            }
                                        },
                                        "total": {
                                            "type": "integer"
                                        }
                                    }
                                }
                            ]
                        }
                    }
                }
            },
            "post": {
                "security": [
                    {
                        "BasicAuth": []
                    }
                ],
                "description": "建立貼文",
                "consumes": [
                    "application/json"
                ],
                "produces": [
                    "application/json"
                ],
                "tags": [
                    "Post"
                ],
                "summary": "建立貼文",
                "parameters": [
                    {
                        "description": "貼文資訊",
                        "name": "PostCreateData",
                        "in": "body",
                        "required": true,
                        "schema": {
                            "$ref": "#/definitions/post.PostCreate"
                        }
                    }
                ],
                "responses": {
                    "201": {
                        "description": "Created"
                    }
                }
            }
        },
        "/posts/{id}": {
            "get": {
                "security": [
                    {
                        "BasicAuth": []
                    }
                ],
                "description": "透過ID取得貼文內容",
                "consumes": [
                    "application/json"
                ],
                "produces": [
                    "application/json"
                ],
                "tags": [
                    "Post"
                ],
                "summary": "取得貼文內容",
                "parameters": [
                    {
                        "type": "string",
                        "description": "貼文ID",
                        "name": "id",
                        "in": "path",
                        "required": true
                    }
                ],
                "responses": {
                    "200": {
                        "description": "OK",
                        "schema": {
                            "allOf": [
                                {
                                    "$ref": "#/definitions/basemodel.BaseResponse"
                                },
                                {
                                    "type": "object",
                                    "properties": {
                                        "data": {
                                            "$ref": "#/definitions/post.Post"
                                        }
                                    }
                                }
                            ]
                        }
                    }
                }
            },
            "delete": {
                "security": [
                    {
                        "BasicAuth": []
                    }
                ],
                "description": "透過ID刪除貼文",
                "consumes": [
                    "application/json"
                ],
                "produces": [
                    "application/json"
                ],
                "tags": [
                    "Post"
                ],
                "summary": "刪除貼文",
                "parameters": [
                    {
                        "type": "string",
                        "description": "貼文ID",
                        "name": "id",
                        "in": "path",
                        "required": true
                    }
                ],
                "responses": {
                    "204": {
                        "description": "No Content"
                    }
                }
            },
            "patch": {
                "security": [
                    {
                        "BasicAuth": []
                    }
                ],
                "description": "透過ID更新貼文內容",
                "consumes": [
                    "application/json"
                ],
                "produces": [
                    "application/json"
                ],
                "tags": [
                    "Post"
                ],
                "summary": "更新貼文內容",
                "parameters": [
                    {
                        "type": "string",
                        "description": "貼文ID",
                        "name": "id",
                        "in": "path",
                        "required": true
                    },
                    {
                        "description": "更新貼文欄位",
                        "name": "PostUpdate",
                        "in": "body",
                        "required": true,
                        "schema": {
                            "$ref": "#/definitions/post.PostUpdate"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "OK"
                    }
                }
            }
        },
        "/users": {
            "get": {
                "security": [
                    {
                        "BasicAuth": []
                    }
                ],
                "description": "取得使用者列表",
                "consumes": [
                    "application/json"
                ],
                "produces": [
                    "application/json"
                ],
                "tags": [
                    "User"
                ],
                "summary": "使用者列表",
                "responses": {
                    "200": {
                        "description": "OK",
                        "schema": {
                            "allOf": [
                                {
                                    "$ref": "#/definitions/basemodel.BaseListResponse"
                                },
                                {
                                    "type": "object",
                                    "properties": {
                                        " data": {
                                            "type": "array",
                                            "items": {
                                                "$ref": "#/definitions/user.UserInfo"
                                            }
                                        },
                                        "total": {
                                            "type": "integer"
                                        }
                                    }
                                }
                            ]
                        }
                    }
                }
            },
            "post": {
                "security": [
                    {
                        "BasicAuth": []
                    }
                ],
                "description": "建立一般使用者",
                "consumes": [
                    "application/json"
                ],
                "produces": [
                    "application/json"
                ],
                "tags": [
                    "User"
                ],
                "summary": "建立使用者",
                "parameters": [
                    {
                        "description": "使用者建立資訊",
                        "name": "UserCreateData",
                        "in": "body",
                        "required": true,
                        "schema": {
                            "$ref": "#/definitions/user.UserCreate"
                        }
                    }
                ],
                "responses": {
                    "201": {
                        "description": "Created"
                    }
                }
            }
        },
        "/users/me": {
            "get": {
                "security": [
                    {
                        "BasicAuth": []
                    }
                ],
                "description": "取得我的基本資訊",
                "consumes": [
                    "application/json"
                ],
                "produces": [
                    "application/json"
                ],
                "tags": [
                    "User"
                ],
                "summary": "取得我的資訊",
                "responses": {
                    "200": {
                        "description": "OK",
                        "schema": {
                            "allOf": [
                                {
                                    "$ref": "#/definitions/basemodel.BaseResponse"
                                },
                                {
                                    "type": "object",
                                    "properties": {
                                        "data": {
                                            "$ref": "#/definitions/user.UserInfo"
                                        }
                                    }
                                }
                            ]
                        }
                    }
                }
            }
        },
        "/users/{id}": {
            "get": {
                "security": [
                    {
                        "BasicAuth": []
                    }
                ],
                "description": "取得使用者",
                "consumes": [
                    "application/json"
                ],
                "produces": [
                    "application/json"
                ],
                "tags": [
                    "User"
                ],
                "summary": "取得使用者資訊",
                "parameters": [
                    {
                        "type": "string",
                        "description": "使用者識別ID",
                        "name": "id",
                        "in": "path",
                        "required": true
                    }
                ],
                "responses": {
                    "200": {
                        "description": "OK",
                        "schema": {
                            "allOf": [
                                {
                                    "$ref": "#/definitions/basemodel.BaseResponse"
                                },
                                {
                                    "type": "object",
                                    "properties": {
                                        "data": {
                                            "$ref": "#/definitions/user.UserInfo"
                                        }
                                    }
                                }
                            ]
                        }
                    }
                }
            },
            "delete": {
                "security": [
                    {
                        "BasicAuth": []
                    }
                ],
                "description": "刪除使用者",
                "consumes": [
                    "application/json"
                ],
                "produces": [
                    "application/json"
                ],
                "tags": [
                    "User"
                ],
                "summary": "刪除使用者",
                "parameters": [
                    {
                        "type": "string",
                        "description": "使用者識別ID",
                        "name": "id",
                        "in": "path",
                        "required": true
                    }
                ],
                "responses": {
                    "204": {
                        "description": "No Content"
                    }
                }
            },
            "patch": {
                "security": [
                    {
                        "BasicAuth": []
                    }
                ],
                "description": "更新使用者",
                "consumes": [
                    "application/json"
                ],
                "produces": [
                    "application/json"
                ],
                "tags": [
                    "User"
                ],
                "summary": "更新使用者資訊",
                "parameters": [
                    {
                        "type": "string",
                        "description": "使用者識別ID",
                        "name": "id",
                        "in": "path",
                        "required": true
                    },
                    {
                        "description": "更新使用者資訊欄位",
                        "name": "UserUpdate",
                        "in": "body",
                        "required": true,
                        "schema": {
                            "$ref": "#/definitions/user.UserUpdate"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "OK"
                    }
                }
            }
        }
    },
    "definitions": {
        "auth.LoginInfo": {
            "type": "object",
            "required": [
                "email",
                "password"
            ],
            "properties": {
                "email": {
                    "type": "string"
                },
                "password": {
                    "type": "string"
                }
            }
        },
        "auth.TokenResponse": {
            "type": "object",
            "properties": {
                "token": {
                    "type": "string"
                }
            }
        },
        "basemodel.BaseListResponse": {
            "type": "object",
            "properties": {
                "data": {},
                "total": {
                    "type": "integer"
                }
            }
        },
        "basemodel.BaseResponse": {
            "type": "object",
            "properties": {
                "data": {}
            }
        },
        "post.Creator": {
            "type": "object",
            "properties": {
                "id": {
                    "type": "string"
                },
                "username": {
                    "type": "string"
                }
            }
        },
        "post.Post": {
            "type": "object",
            "properties": {
                "content": {
                    "type": "string"
                },
                "created_at": {
                    "type": "string"
                },
                "creator": {
                    "$ref": "#/definitions/post.Creator"
                },
                "id": {
                    "type": "string"
                },
                "title": {
                    "type": "string"
                }
            }
        },
        "post.PostCreate": {
            "type": "object",
            "properties": {
                "content": {
                    "type": "string"
                },
                "title": {
                    "type": "string"
                }
            }
        },
        "post.PostList": {
            "type": "object",
            "properties": {
                "creator": {
                    "$ref": "#/definitions/post.Creator"
                },
                "id": {
                    "type": "string"
                },
                "title": {
                    "type": "string"
                }
            }
        },
        "post.PostUpdate": {
            "type": "object",
            "properties": {
                "content": {
                    "type": "string"
                },
                "title": {
                    "type": "string"
                }
            }
        },
        "user.UserCreate": {
            "type": "object",
            "required": [
                "email",
                "password",
                "username"
            ],
            "properties": {
                "email": {
                    "type": "string"
                },
                "password": {
                    "type": "string"
                },
                "username": {
                    "type": "string"
                }
            }
        },
        "user.UserInfo": {
            "type": "object",
            "properties": {
                "email": {
                    "type": "string"
                },
                "id": {
                    "type": "string"
                },
                "username": {
                    "type": "string"
                }
            }
        },
        "user.UserUpdate": {
            "type": "object",
            "properties": {
                "email": {
                    "type": "string"
                },
                "username": {
                    "type": "string"
                }
            }
        }
    },
    "securityDefinitions": {
        "BasicAuth": {
            "type": "apiKey",
            "name": "Authorization",
            "in": "header"
        }
    }
}`

// SwaggerInfo holds exported Swagger Info so clients can modify it
var SwaggerInfo = &amp;swag.Spec{
        Version:          "0.1.0",
        Host:             "",
        BasePath:         "/",
        Schemes:          []string{},
        Title:            "Blog API",
        Description:      "嗨~你好~",
        InfoInstanceName: "swagger",
        SwaggerTemplate:  docTemplate,
        LeftDelim:        "{{",
        RightDelim:       "}}",
}

func init() <span class="cov0" title="0">{
        swag.Register(SwaggerInfo.InstanceName(), SwaggerInfo)
}</span>
</pre>
		
		<pre class="file" id="file4" style="display: none">package auth

import (
        "net/http"
        AuthSchema "wentee/blog/app/schema/auth"
        "wentee/blog/app/schema/basemodel"
        AuthSvc "wentee/blog/app/services/auth"

        "github.com/gin-gonic/gin"
)

type AuthRouter struct {
        authSvc *AuthSvc.AuthService
}

func NewAuthRouter(authSvc *AuthSvc.AuthService) *AuthRouter <span class="cov0" title="0">{

        return &amp;AuthRouter{
                authSvc: authSvc,
        }
}</span>

// @Summary        登入API
// @Tags                Auth
// @Accept                application/json
// @Produce        application/json
// @Param                loginInfo        body                AuthSchema.LoginInfo        true        "登入資訊"
// @Success        200                        {object}        basemodel.BaseResponse{data=AuthSchema.TokenResponse}
// @Router                /auth/login        [post]
func (api *AuthRouter) Login(c *gin.Context) <span class="cov0" title="0">{
        ctx := c.Request.Context()
        var loginInfo AuthSchema.LoginInfo
        if err := c.ShouldBindJSON(&amp;loginInfo); err != nil </span><span class="cov0" title="0">{
                c.Error(err)
                return
        }</span>
        <span class="cov0" title="0">tokenString, err := api.authSvc.TryLogin(ctx, &amp;loginInfo)

        if err != nil </span><span class="cov0" title="0">{
                c.Error(err)
                return
        }</span>

        <span class="cov0" title="0">c.JSON(http.StatusOK, basemodel.BaseResponse{Data: AuthSchema.TokenResponse{Token: tokenString}})</span>
}
</pre>
		
		<pre class="file" id="file5" style="display: none">package post

import (
        "net/http"
        "wentee/blog/app/schema/basemodel"
        PostSchema "wentee/blog/app/schema/post"
        PostSvc "wentee/blog/app/services/post"
        "wentee/blog/app/utils/reqcontext"

        "github.com/gin-gonic/gin"
)

type PostRouter struct {
        postSvc PostSvc.IPostService
}

func NewPostRouter(postSvc *PostSvc.PostService) *PostRouter <span class="cov0" title="0">{
        return &amp;PostRouter{
                postSvc: postSvc,
        }
}</span>

// @summary 建立貼文
// @description 建立貼文
// @security BasicAuth
// @tags Post
// @accept application/json
// @produce application/json
// @param PostCreateData body PostSchema.PostCreate true "貼文資訊"
// @Success        201
// @router /posts [POST]
func (api *PostRouter) CreatePost(c *gin.Context) <span class="cov0" title="0">{
        ctx := c.Request.Context()
        userInfo, err := reqcontext.GetUserInfo(c)

        if err != nil </span><span class="cov0" title="0">{
                c.Error(err)
                return
        }</span>

        <span class="cov0" title="0">var postCreate PostSchema.PostCreate
        if err := c.ShouldBindJSON(&amp;postCreate); err != nil </span><span class="cov0" title="0">{
                c.Error(err)
                return
        }</span>
        <span class="cov0" title="0">if err := api.postSvc.CreatePost(ctx, &amp;postCreate, userInfo.Id); err != nil </span><span class="cov0" title="0">{
                c.Error(err)
                return
        }</span>
}

// @summary 貼文列表
// @description 取得貼文列表
// @security BasicAuth
// @tags Post
// @accept application/json
// @produce application/json
// @Success        200 {object} basemodel.BaseListResponse{total=int, data=[]PostSchema.PostList}
// @router /posts [GET]
func (api *PostRouter) ListPosts(c *gin.Context) <span class="cov0" title="0">{
        ctx := c.Request.Context()
        query := basemodel.NewDefaultQuery()
        if err := c.ShouldBindQuery(&amp;query); err != nil </span><span class="cov0" title="0">{
                c.Error(err)
                return
        }</span>

        <span class="cov0" title="0">total, posts, err := api.postSvc.ListPosts(ctx, &amp;query)
        if err != nil </span><span class="cov0" title="0">{
                c.Error(err)
                return
        }</span>
        <span class="cov0" title="0">c.JSON(http.StatusOK, basemodel.BaseListResponse{Total: total, Data: posts})</span>
}

// @summary 取得貼文內容
// @description 透過ID取得貼文內容
// @security BasicAuth
// @tags Post
// @accept application/json
// @produce application/json
// @param id path string true "貼文ID"
// @Success        200 {object} basemodel.BaseResponse{data=PostSchema.Post}
// @router /posts/{id} [GET]
func (api *PostRouter) GetPost(c *gin.Context) <span class="cov0" title="0">{
        ctx := c.Request.Context()
        id := c.Param("id")

        post, err := api.postSvc.GetPostById(ctx, id)
        if err != nil </span><span class="cov0" title="0">{
                c.Error(err)
                return
        }</span>
        <span class="cov0" title="0">c.JSON(http.StatusOK, basemodel.BaseResponse{Data: post})</span>
}

// @summary 更新貼文內容
// @description 透過ID更新貼文內容
// @security BasicAuth
// @tags Post
// @accept application/json
// @produce application/json
// @param id path string true "貼文ID"
// @Param PostUpdate body PostSchema.PostUpdate true "更新貼文欄位"
// @Success        200
// @router /posts/{id} [PATCH]
func (api *PostRouter) UpdatePost(c *gin.Context) <span class="cov0" title="0">{
        ctx := c.Request.Context()
        id := c.Param("id")
        var updateData PostSchema.PostUpdate

        if err := c.ShouldBindJSON(&amp;updateData); err != nil </span><span class="cov0" title="0">{
                c.Error(err)
                return
        }</span>
        <span class="cov0" title="0">if err := api.postSvc.UpdatePostById(ctx, id, &amp;updateData); err != nil </span><span class="cov0" title="0">{
                c.Error(err)
                return
        }</span>

}

// @summary 刪除貼文
// @description 透過ID刪除貼文
// @security BasicAuth
// @tags Post
// @accept application/json
// @produce application/json
// @param id path string true "貼文ID"
// @Success        204
// @router /posts/{id} [DELETE]
func (api *PostRouter) DeletePost(c *gin.Context) <span class="cov0" title="0">{
        ctx := c.Request.Context()
        id := c.Param("id")

        if err := api.postSvc.DeletePostById(ctx, id); err != nil </span><span class="cov0" title="0">{
                c.Error(err)
                return
        }</span>

}
</pre>
		
		<pre class="file" id="file6" style="display: none">package user

import (
        "net/http"
        "wentee/blog/app/schema/basemodel"
        UserSchema "wentee/blog/app/schema/user"
        UserSvc "wentee/blog/app/services/user"
        "wentee/blog/app/utils/reqcontext"

        "github.com/gin-gonic/gin"
)

type UserRouter struct {
        userSvc UserSvc.IUserService
}

func NewUserRouter(userSvc *UserSvc.UserService) *UserRouter <span class="cov0" title="0">{
        return &amp;UserRouter{
                userSvc: userSvc,
        }
}</span>

// @summary 建立使用者
// @description 建立一般使用者
// @security BasicAuth
// @tags User
// @accept application/json
// @produce application/json
// @param UserCreateData body UserSchema.UserCreate true "使用者建立資訊"
// @Success        201
// @router /users [POST]
func (api *UserRouter) CreateUser(c *gin.Context) <span class="cov0" title="0">{
        ctx := c.Request.Context()
        var userCreate UserSchema.UserCreate

        if err := c.ShouldBindJSON(&amp;userCreate); err != nil </span><span class="cov0" title="0">{
                c.Error(err)
                return
        }</span>

        <span class="cov0" title="0">if err := api.userSvc.RegistryUser(ctx, &amp;userCreate); err != nil </span><span class="cov0" title="0">{
                c.Error(err)
                return
        }</span>
        <span class="cov0" title="0">c.Status(http.StatusCreated)</span>
}

// @summary 取得使用者資訊
// @description 取得使用者
// @security BasicAuth
// @tags User
// @accept application/json
// @produce application/json
// @param id path string true "使用者識別ID"
// @Success        200 {object} basemodel.BaseResponse{data=UserSchema.UserInfo}
// @router /users/{id} [GET]
func (api *UserRouter) GetUser(c *gin.Context) <span class="cov0" title="0">{
        ctx := c.Request.Context()
        id := c.Param("id")
        userData, err := api.userSvc.GetUserById(ctx, id)

        if err != nil </span><span class="cov0" title="0">{
                c.Error(err)
                return
        }</span>
        <span class="cov0" title="0">c.JSON(http.StatusOK, basemodel.BaseResponse{Data: userData})</span>

}

// @summary 使用者列表
// @description 取得使用者列表
// @security BasicAuth
// @tags User
// @accept application/json
// @produce application/json
// @Success        200 {object} basemodel.BaseListResponse{total=int, data=[]UserSchema.UserInfo}
// @router /users [GET]
func (api *UserRouter) ListUsers(c *gin.Context) <span class="cov0" title="0">{
        ctx := c.Request.Context()
        baseQuery := basemodel.NewDefaultQuery()

        if err := c.ShouldBindQuery(&amp;baseQuery); err != nil </span><span class="cov0" title="0">{
                c.Error(err)
                return
        }</span>
        <span class="cov0" title="0">total, err := api.userSvc.CountUsers(ctx)

        if err != nil </span><span class="cov0" title="0">{
                c.Error(err)
                return
        }</span>

        <span class="cov0" title="0">users, err := api.userSvc.ListUsers(ctx, &amp;baseQuery)
        if err != nil </span><span class="cov0" title="0">{
                c.Error(err)
                return
        }</span>
        <span class="cov0" title="0">c.JSON(http.StatusOK, basemodel.BaseListResponse{Total: total, Data: users})</span>
}

// @summary 取得我的資訊
// @description 取得我的基本資訊
// @security BasicAuth
// @tags User
// @accept application/json
// @produce application/json
// @Success        200 {object} basemodel.BaseResponse{data=UserSchema.UserInfo}
// @router /users/me [GET]
func (api *UserRouter) GetMe(c *gin.Context) <span class="cov0" title="0">{
        ctx := c.Request.Context()
        userInfo, err := reqcontext.GetUserInfo(c)
        if err != nil </span><span class="cov0" title="0">{
                c.Error(err)
                return
        }</span>

        <span class="cov0" title="0">userData, err := api.userSvc.GetUserById(ctx, userInfo.Id)

        if err != nil </span><span class="cov0" title="0">{
                c.Error(err)
                return
        }</span>
        <span class="cov0" title="0">c.JSON(http.StatusOK, basemodel.BaseResponse{Data: userData})</span>
}

// @summary 刪除使用者
// @description 刪除使用者
// @security BasicAuth
// @tags User
// @accept application/json
// @produce application/json
// @param id path string true "使用者識別ID"
// @Success        204
// @router /users/{id} [DELETE]
func (api *UserRouter) DeleteUser(c *gin.Context) <span class="cov0" title="0">{
        ctx := c.Request.Context()
        err := api.userSvc.DeleteUserById(ctx, c.Param("id"))

        if err != nil </span><span class="cov0" title="0">{
                c.Error(err)
                return
        }</span>
        <span class="cov0" title="0">c.Status(http.StatusNoContent)</span>
}

// @summary 更新使用者資訊
// @description 更新使用者
// @security BasicAuth
// @tags User
// @accept application/json
// @produce application/json
// @param id path string true "使用者識別ID"
// @Param UserUpdate body UserSchema.UserUpdate true "更新使用者資訊欄位"
// @Success        200
// @router /users/{id} [PATCH]
func (api *UserRouter) UpdateUser(c *gin.Context) <span class="cov0" title="0">{
        ctx := c.Request.Context()
        id := c.Param("id")
        var userUpdate UserSchema.UserUpdate

        if err := c.ShouldBindJSON(&amp;userUpdate); err != nil </span><span class="cov0" title="0">{
                c.Error(err)
                return
        }</span>
        <span class="cov0" title="0">if err := api.userSvc.UpdateUserById(ctx, id, &amp;userUpdate); err != nil </span><span class="cov0" title="0">{
                c.Error(err)
                return
        }</span>

}
</pre>
		
		<pre class="file" id="file7" style="display: none">package main

import (
        "wentee/blog/app/appinit"
        "wentee/blog/app/config"
        "wentee/blog/app/di"
        _ "wentee/blog/app/docs"
        "wentee/blog/app/routes"

        swaggerFiles "github.com/swaggo/files"
        ginSwagger "github.com/swaggo/gin-swagger"
        "go.mongodb.org/mongo-driver/mongo/options"
)

//        @title                        Blog API
//        @version                0.1.0
//        @description        嗨~你好~
//        @basePath                /

// @securityDefinitions.apikey        BasicAuth
// @in                                                        header
// @name                                                Authorization
func main() <span class="cov0" title="0">{
        appCtx := setupCtx()
        container := di.InitContainer(appCtx)
        router := routes.SetupRouter(container)

        router.GET("/swagger/*any", ginSwagger.WrapHandler(swaggerFiles.Handler))
        router.Run(":8080")

}</span>

func setupCtx() *appinit.AppContext <span class="cov0" title="0">{
        newContext := &amp;appinit.AppContext{
                MongoClient: appinit.GetMongoClient(options.Client().ApplyURI(config.MONGO_URI)),
        }

        return newContext
}</span>
</pre>
		
		<pre class="file" id="file8" style="display: none">package middleware

import (
        "errors"
        "net/http"
        "wentee/blog/app/config"
        "wentee/blog/app/schema/apperror"
        "wentee/blog/app/schema/apperror/errcode"
        AuthSchema "wentee/blog/app/schema/auth"
        "wentee/blog/app/utils/reqcontext"

        "github.com/gin-gonic/gin"
        "github.com/golang-jwt/jwt/v5"
)

type AuthMiddleware struct {
        // userCollection *mongo.Collection
}

func (authMiddleware *AuthMiddleware) RequiredAuth() gin.HandlerFunc <span class="cov0" title="0">{
        return func(c *gin.Context) </span><span class="cov0" title="0">{
                tokenString := c.GetHeader("Authorization")

                if tokenString == "" </span><span class="cov0" title="0">{
                        c.Error(apperror.New(http.StatusForbidden, errcode.INVALID_TOKEN, nil))
                        c.Abort()
                        return
                }</span>
                <span class="cov0" title="0">token, err := jwt.ParseWithClaims(tokenString, &amp;AuthSchema.JWTClaims{}, func(token *jwt.Token) (any, error) </span><span class="cov0" title="0">{

                        return []byte(config.JWT_SECRET), nil
                }</span>)

                <span class="cov0" title="0">if err != nil </span><span class="cov0" title="0">{
                        switch </span>{
                        case errors.Is(err, jwt.ErrSignatureInvalid):<span class="cov0" title="0">
                                c.Error(apperror.New(http.StatusForbidden, errcode.INVALID_TOKEN, err))</span>
                        case errors.Is(err, jwt.ErrTokenExpired):<span class="cov0" title="0">
                                c.Error(apperror.New(http.StatusForbidden, errcode.EXPIRED_TOKEN, err))</span>
                        default:<span class="cov0" title="0">
                                c.Error(err)</span>
                        }
                        <span class="cov0" title="0">c.Abort()
                        return</span>
                }
                <span class="cov0" title="0">claim, ok := token.Claims.(*AuthSchema.JWTClaims)
                if !ok </span><span class="cov0" title="0">{
                        c.Error(apperror.New(http.StatusForbidden, errcode.INVALID_TOKEN, nil))
                        c.Abort()
                        return
                }</span>

                <span class="cov0" title="0">c.Set(reqcontext.USER_INFO, claim.UserInfo)
                c.Next()</span>
        }
}
</pre>
		
		<pre class="file" id="file9" style="display: none">package middleware

import (
        "fmt"
        "net/http"
        "wentee/blog/app/schema/apperror"

        "github.com/gin-gonic/gin"
        "github.com/go-playground/validator/v10"
)

type HandlerFuncWithError func(c *gin.Context) error

func ErrorHandler() gin.HandlerFunc <span class="cov0" title="0">{
        return func(c *gin.Context) </span><span class="cov0" title="0">{
                c.Next() // Run This Before

                if len(c.Errors) &gt; 0 </span><span class="cov0" title="0">{
                        err := c.Errors.Last().Err

                        switch e := err.(type) </span>{
                        case apperror.AppError:<span class="cov0" title="0">
                                c.JSON(e.Status, gin.H{"Code": e.Code, "Message": e.GetMessage()})</span>
                        case validator.ValidationErrors:<span class="cov0" title="0">
                                fieldErrs := make([]string, len(e))

                                for i, fieldErr := range e </span><span class="cov0" title="0">{
                                        fieldErrs[i] = fmt.Sprintf("%v", fieldErr.Error())
                                }</span>

                                <span class="cov0" title="0">c.JSON(http.StatusUnprocessableEntity, gin.H{"Message": fieldErrs})</span>
                        default:<span class="cov0" title="0">
                                c.JSON(http.StatusInternalServerError, gin.H{"Message": "Internal Server Error"})</span>
                        }
                }
        }
}
</pre>
		
		<pre class="file" id="file10" style="display: none">package post

import (
        "context"
        "time"
        PostModel "wentee/blog/app/model/mongodb/post"
        "wentee/blog/app/schema/basemodel"
        PostSchema "wentee/blog/app/schema/post"
        "wentee/blog/app/utils/mongo/mongoutils"

        "go.mongodb.org/mongo-driver/bson"
        "go.mongodb.org/mongo-driver/bson/primitive"
)

type PostRepo struct {
        postColletion IPostCollection
        docCounter    mongoutils.DocumentCounter
}

func NewPostRepo(postColletion IPostCollection, docCounter mongoutils.DocumentCounter) *PostRepo <span class="cov8" title="1">{
        return &amp;PostRepo{
                postColletion: postColletion,
                docCounter:    docCounter,
        }
}</span>

func (repo *PostRepo) CreatePost(ctx context.Context, postCreate *PostSchema.PostCreate, createdBy *primitive.ObjectID) (err error) <span class="cov8" title="1">{
        _, err = repo.postColletion.InsertOne(ctx, PostModel.PostDocument{
                Title:     postCreate.Title,
                Content:   postCreate.Content,
                CreatedAt: time.Now().UTC(),
                CreatedBy: *createdBy,
        })
        return
}</span>

func (repo *PostRepo) ListPosts(ctx context.Context, query *basemodel.BaseQuery) (total int64, posts []PostModel.PostWithCreatorDocument, err error) <span class="cov8" title="1">{
        countPipe, queryPipe := getPostWithCreatorListPipeline(query.Skip, query.Limit)
        total, err = repo.docCounter.CountDocumentWithPipeline(ctx, repo.postColletion, countPipe)
        if err != nil </span><span class="cov8" title="1">{
                return
        }</span>
        <span class="cov8" title="1">cursor, err := repo.postColletion.Aggregate(ctx, queryPipe)
        if err != nil </span><span class="cov8" title="1">{
                return
        }</span>
        <span class="cov8" title="1">defer cursor.Close(ctx)
        err = cursor.All(ctx, &amp;posts)
        return</span>
}

func (repo *PostRepo) GetPostById(ctx context.Context, id primitive.ObjectID) (post PostModel.PostWithCreatorDocument, err error) <span class="cov8" title="1">{
        pipeline := bson.A{
                bson.D{{Key: "$match", Value: bson.D{{Key: "_id", Value: id}}}},
                bson.D{
                        {Key: "$lookup",
                                Value: bson.D{
                                        {Key: "from", Value: "User"},
                                        {
                                                Key:   "let",
                                                Value: bson.D{{Key: "userId", Value: "$CreatedBy"}},
                                        },
                                        {
                                                Key: "pipeline",
                                                Value: bson.A{
                                                        bson.D{
                                                                {
                                                                        Key: "$project",
                                                                        Value: bson.D{
                                                                                {Key: "Password", Value: 0},
                                                                                {Key: "Salt", Value: 0},
                                                                        },
                                                                },
                                                        },
                                                },
                                        },
                                        {Key: "as", Value: "Creator"},
                                },
                        },
                },
                bson.D{
                        {
                                Key: "$unwind",
                                Value: bson.D{
                                        {Key: "path", Value: "$Creator"},
                                        {Key: "preserveNullAndEmptyArrays", Value: true},
                                },
                        },
                },
                bson.D{{Key: "$project", Value: bson.D{{Key: "CreatedBy", Value: 0}}}},
        }

        cursor, err := repo.postColletion.Aggregate(ctx, pipeline)

        if err != nil </span><span class="cov8" title="1">{
                return
        }</span>

        <span class="cov8" title="1">defer cursor.Close(ctx)

        if cursor.Next(ctx) </span><span class="cov8" title="1">{
                cursor.Decode(&amp;post)
        }</span>

        <span class="cov8" title="1">return</span>
}

func (repo *PostRepo) UpdatePostById(ctx context.Context, id primitive.ObjectID, updateData *PostSchema.PostUpdate) (err error) <span class="cov8" title="1">{
        _, err = repo.postColletion.UpdateOne(ctx, bson.M{PostModel.FieldId: id}, bson.M{"$set": updateData})
        return
}</span>

func (repo *PostRepo) DeletePostById(ctx context.Context, id primitive.ObjectID) (err error) <span class="cov8" title="1">{
        _, err = repo.postColletion.DeleteOne(ctx, bson.M{PostModel.FieldId: id})
        return
}</span>
</pre>
		
		<pre class="file" id="file11" style="display: none">package post

import (
        "context"
        PostModel "wentee/blog/app/model/mongodb/post"
        "wentee/blog/app/schema/basemodel"
        PostSchema "wentee/blog/app/schema/post"
        "wentee/blog/app/utils/mongo/imongo"

        "go.mongodb.org/mongo-driver/bson/primitive"
        "go.mongodb.org/mongo-driver/mongo"
        "go.mongodb.org/mongo-driver/mongo/options"
)

type IPostCollection interface {
        imongo.IInsertOne
        imongo.IAggregate
        imongo.IUpdateOne
        imongo.IDeleteOne
}

type PostCollectionAdapter struct {
        Collection *mongo.Collection
}

// Aggregate implements IPostCollection.
func (p *PostCollectionAdapter) Aggregate(ctx context.Context, pipeline interface{}, opts ...*options.AggregateOptions) (imongo.Cursor, error) <span class="cov0" title="0">{
        return p.Collection.Aggregate(ctx, pipeline, opts...)
}</span>

// DeleteOne implements IPostCollection.
func (p *PostCollectionAdapter) DeleteOne(ctx context.Context, filter any, opts ...*options.DeleteOptions) (imongo.DeleteResult, error) <span class="cov0" title="0">{
        return p.Collection.DeleteOne(ctx, filter, opts...)
}</span>

// InsertOne implements IPostCollection.
func (p *PostCollectionAdapter) InsertOne(ctx context.Context, document any, opts ...*options.InsertOneOptions) (imongo.InsertOneResult, error) <span class="cov0" title="0">{
        return p.Collection.InsertOne(ctx, document, opts...)
}</span>

// UpdateOne implements IPostCollection.
func (p *PostCollectionAdapter) UpdateOne(ctx context.Context, filter any, update any, opts ...*options.UpdateOptions) (imongo.UpdateResult, error) <span class="cov0" title="0">{
        return p.Collection.UpdateOne(ctx, filter, update, opts...)
}</span>

type IPostRepository interface {
        CreatePost(ctx context.Context, postCreate *PostSchema.PostCreate, createdBy *primitive.ObjectID) (err error)
        ListPosts(ctx context.Context, query *basemodel.BaseQuery) (total int64, posts []PostModel.PostWithCreatorDocument, err error)
        GetPostById(ctx context.Context, id primitive.ObjectID) (post PostModel.PostWithCreatorDocument, err error)
        UpdatePostById(ctx context.Context, id primitive.ObjectID, updateData *PostSchema.PostUpdate) (err error)
        DeletePostById(ctx context.Context, id primitive.ObjectID) (err error)
}
</pre>
		
		<pre class="file" id="file12" style="display: none">package post

import (
        "wentee/blog/app/utils/mongo/pipefactory"

        "go.mongodb.org/mongo-driver/bson"
)

func getPostWithCreatorListPipeline(skip, limit int64) (countPipeline, queryPipeline bson.A) <span class="cov8" title="1">{
        pb := pipefactory.NewPipelineBuilder()
        pb.AddOperations(
                bson.D{
                        {
                                Key: "$lookup",
                                Value: bson.D{
                                        {Key: "from", Value: "User"},
                                        {Key: "let", Value: bson.D{{Key: "userId", Value: "$CreatedBy"}}},
                                        {
                                                Key: "pipeline",
                                                Value: bson.A{
                                                        bson.D{
                                                                {
                                                                        Key: "$match",
                                                                        Value: bson.D{
                                                                                {
                                                                                        Key: "$expr",
                                                                                        Value: bson.D{
                                                                                                {
                                                                                                        Key: "$eq",
                                                                                                        Value: bson.A{
                                                                                                                "$_id",
                                                                                                                "$$userId",
                                                                                                        },
                                                                                                },
                                                                                        },
                                                                                },
                                                                        },
                                                                },
                                                        },
                                                        bson.D{
                                                                {
                                                                        Key: "$project",
                                                                        Value: bson.D{
                                                                                {Key: "Password", Value: 0},
                                                                                {Key: "Salt", Value: 0},
                                                                        },
                                                                },
                                                        },
                                                },
                                        },
                                        {Key: "as", Value: "Creator"},
                                },
                        },
                },
                bson.D{{Key: "$project", Value: bson.D{{Key: "CreatedBy", Value: 0}}}},
                bson.D{{Key: "$unwind", Value: bson.D{{Key: "path", Value: "$Creator"}}}},
        ).AddSkip(skip).AddLimit(limit).AddSort(bson.D{{Key: "CreatedAt", Value: -1}})
        countPipeline = pb.BuildCountPipeline()
        queryPipeline = pb.BuildQeuryPipeline()
        return
}</span>
</pre>
		
		<pre class="file" id="file13" style="display: none">package user

import (
        "context"
        "errors"
        "net/http"
        UserModel "wentee/blog/app/model/mongodb/user"
        "wentee/blog/app/schema/apperror"
        "wentee/blog/app/schema/apperror/errcode"
        "wentee/blog/app/schema/basemodel"
        UserSchema "wentee/blog/app/schema/user"

        "go.mongodb.org/mongo-driver/bson"
        "go.mongodb.org/mongo-driver/bson/primitive"
        "go.mongodb.org/mongo-driver/mongo"
        "go.mongodb.org/mongo-driver/mongo/options"
)

type UserRepo struct {
        UserCollection IUserCollection
}

func NewUserRepo(userCollection IUserCollection) *UserRepo <span class="cov8" title="1">{

        return &amp;UserRepo{
                UserCollection: userCollection,
        }
}</span>
func (repo *UserRepo) CountUsers(ctx context.Context) (int64, error) <span class="cov8" title="1">{
        return repo.UserCollection.CountDocuments(ctx, bson.M{})
}</span>

func (repo *UserRepo) CreateUser(ctx context.Context, createUser *UserModel.UserDocument) error <span class="cov8" title="1">{
        _, err := repo.UserCollection.InsertOne(ctx, createUser)
        return err
}</span>

func (repo *UserRepo) QueryUsers(ctx context.Context, query *basemodel.BaseQuery) ([]UserModel.UserDocument, error) <span class="cov8" title="1">{
        var userDocs []UserModel.UserDocument

        cur, err := repo.UserCollection.Find(ctx, bson.M{}, options.Find().SetSkip(query.Skip).SetLimit(query.Limit))

        if err != nil </span><span class="cov8" title="1">{
                return nil, err
        }</span>

        <span class="cov8" title="1">if err := cur.All(ctx, &amp;userDocs); err != nil </span><span class="cov8" title="1">{
                return nil, err
        }</span>

        <span class="cov8" title="1">return userDocs, nil</span>
}

func (repo *UserRepo) GetUserById(ctx context.Context, id primitive.ObjectID, opts ...*options.FindOneOptions) (*UserModel.UserDocument, error) <span class="cov8" title="1">{
        var userDoc UserModel.UserDocument
        if err := repo.UserCollection.FindOne(ctx, bson.M{UserModel.FieldId: id}, opts...).Decode(&amp;userDoc); err != nil </span><span class="cov8" title="1">{
                if errors.Is(err, mongo.ErrNoDocuments) </span><span class="cov8" title="1">{
                        return nil, apperror.New(http.StatusNotFound, errcode.USER_NOT_FOUND, err)
                }</span>
                <span class="cov8" title="1">return nil, err</span>
        }
        <span class="cov8" title="1">return &amp;userDoc, nil</span>
}

func (repo *UserRepo) GetUserByEmail(ctx context.Context, email string, opts ...*options.FindOneOptions) (*UserModel.UserDocument, error) <span class="cov8" title="1">{
        var userDoc UserModel.UserDocument
        if err := repo.UserCollection.FindOne(ctx, bson.M{UserModel.FieldEmail: email}, opts...).Decode(&amp;userDoc); err != nil </span><span class="cov8" title="1">{
                if errors.Is(err, mongo.ErrNoDocuments) </span><span class="cov8" title="1">{
                        return nil, apperror.New(http.StatusNotFound, errcode.USER_NOT_FOUND, err)
                }</span>
                <span class="cov8" title="1">return nil, err</span>
        }
        <span class="cov8" title="1">return &amp;userDoc, nil</span>
}

func (repo *UserRepo) UpdateUserById(ctx context.Context, id primitive.ObjectID, updateData *UserSchema.UserUpdate, opts ...*options.UpdateOptions) (err error) <span class="cov8" title="1">{
        _, err = repo.UserCollection.UpdateOne(ctx, bson.M{UserModel.FieldId: id}, bson.M{"$set": updateData})
        return
}</span>

func (repo *UserRepo) DeleteUserById(ctx context.Context, id primitive.ObjectID, opts ...*options.DeleteOptions) (err error) <span class="cov8" title="1">{
        _, err = repo.UserCollection.DeleteOne(ctx, bson.M{UserModel.FieldId: id}, opts...)
        return
}</span>
</pre>
		
		<pre class="file" id="file14" style="display: none">package user

import (
        "context"
        UserModel "wentee/blog/app/model/mongodb/user"
        "wentee/blog/app/schema/basemodel"
        UserSchema "wentee/blog/app/schema/user"
        "wentee/blog/app/utils/mongo/imongo"

        "go.mongodb.org/mongo-driver/bson/primitive"
        "go.mongodb.org/mongo-driver/mongo"
        "go.mongodb.org/mongo-driver/mongo/options"
)

type IUserCollection interface {
        imongo.ICountDocuments
        imongo.IFind
        imongo.IFindOne
        imongo.IInsertOne
        imongo.IUpdateOne
        imongo.IDeleteOne
}

type UserCollectionAdapter struct {
        Collection *mongo.Collection
}

// CountDocuments implements IUserCollection.
func (u *UserCollectionAdapter) CountDocuments(ctx context.Context, filter any, opts ...*options.CountOptions) (int64, error) <span class="cov0" title="0">{
        return u.Collection.CountDocuments(ctx, filter, opts...)
}</span>

// DeleteOne implements IUserCollection.
func (u *UserCollectionAdapter) DeleteOne(ctx context.Context, filter any, opts ...*options.DeleteOptions) (imongo.DeleteResult, error) <span class="cov0" title="0">{
        return u.Collection.DeleteOne(ctx, filter, opts...)
}</span>

// Find implements IUserCollection.
func (u *UserCollectionAdapter) Find(ctx context.Context, filter any, opts ...*options.FindOptions) (imongo.Cursor, error) <span class="cov0" title="0">{
        return u.Collection.Find(ctx, filter, opts...)
}</span>

// FindOne implements IUserCollection.
func (u *UserCollectionAdapter) FindOne(ctx context.Context, filter any, opts ...*options.FindOneOptions) imongo.SingleResult <span class="cov0" title="0">{
        return u.Collection.FindOne(ctx, filter, opts...)
}</span>

// InsertOne implements IUserCollection.
func (u *UserCollectionAdapter) InsertOne(ctx context.Context, doc any, opts ...*options.InsertOneOptions) (imongo.InsertOneResult, error) <span class="cov0" title="0">{
        return u.Collection.InsertOne(ctx, doc, opts...)
}</span>

// UpdateOne implements IUserCollection.
func (u *UserCollectionAdapter) UpdateOne(ctx context.Context, filter any, update any, opts ...*options.UpdateOptions) (imongo.UpdateResult, error) <span class="cov0" title="0">{
        return u.Collection.UpdateOne(ctx, filter, update, opts...)
}</span>

type IUserRepository interface {
        CountUsers(context.Context) (int64, error)
        CreateUser(context.Context, *UserModel.UserDocument) error
        QueryUsers(context.Context, *basemodel.BaseQuery) ([]UserModel.UserDocument, error)
        GetUserById(context.Context, primitive.ObjectID, ...*options.FindOneOptions) (*UserModel.UserDocument, error)
        UpdateUserById(context.Context, primitive.ObjectID, *UserSchema.UserUpdate, ...*options.UpdateOptions) error
        DeleteUserById(context.Context, primitive.ObjectID, ...*options.DeleteOptions) error
        IGetUserByMail
}

type IGetUserByMail interface {
        GetUserByEmail(context.Context, string, ...*options.FindOneOptions) (*UserModel.UserDocument, error)
}
</pre>
		
		<pre class="file" id="file15" style="display: none">package routes

import (
        "wentee/blog/app/di"
        "wentee/blog/app/middleware"
        v1 "wentee/blog/app/routes/v1"

        "github.com/gin-gonic/gin"
)

func SetupRouter(container *di.Container) *gin.Engine <span class="cov0" title="0">{
        r := gin.New()

        r.Use(gin.Logger())
        r.Use(gin.Recovery())
        r.Use(middleware.ErrorHandler())
        authMiddleware := middleware.AuthMiddleware{}

        v1.RegistryAuthRouter(r.Group("/auth"), container)
        v1.RegistryUserRouter(r.Group("/users", authMiddleware.RequiredAuth()), container)
        v1.RegistryPostRouter(r.Group("/posts", authMiddleware.RequiredAuth()), container)

        return r
}</span>
</pre>
		
		<pre class="file" id="file16" style="display: none">package v1

import (
        "wentee/blog/app/di"

        "github.com/gin-gonic/gin"
)

func RegistryAuthRouter(rg *gin.RouterGroup, container *di.Container) <span class="cov0" title="0">{
        rg.POST("/login", container.AuthRouter.Login)
}</span>
</pre>
		
		<pre class="file" id="file17" style="display: none">package v1

import (
        "wentee/blog/app/di"

        "github.com/gin-gonic/gin"
)

func RegistryPostRouter(rg *gin.RouterGroup, container *di.Container) <span class="cov0" title="0">{
        rg.POST("", container.PostRouter.CreatePost)
        rg.GET("", container.PostRouter.ListPosts)

        id_group := rg.Group("/:id")
        </span><span class="cov0" title="0">{
                id_group.GET("", container.PostRouter.GetPost)
                id_group.PATCH("", container.PostRouter.UpdatePost)
                id_group.DELETE("", container.PostRouter.DeletePost)
        }</span>
}
</pre>
		
		<pre class="file" id="file18" style="display: none">package v1

import (
        "wentee/blog/app/di"

        "github.com/gin-gonic/gin"
)

func RegistryUserRouter(rg *gin.RouterGroup, container *di.Container) <span class="cov0" title="0">{
        rg.POST("", container.UserRouter.CreateUser)
        rg.GET("", container.UserRouter.ListUsers)
        rg.GET("/me", container.UserRouter.GetMe)

        id_rg := rg.Group("/:id")
        </span><span class="cov0" title="0">{
                id_rg.GET("", container.UserRouter.GetUser)
                id_rg.PATCH("", container.UserRouter.UpdateUser)
                id_rg.DELETE("", container.UserRouter.DeleteUser)
        }</span>
}
</pre>
		
		<pre class="file" id="file19" style="display: none">package apperror

import "wentee/blog/app/schema/apperror/errcode"

type AppError struct {
        Code    string
        Message string
        Status  int
        Err     error
}

func (appError *AppError) GetMessage() string <span class="cov0" title="0">{
        return errcode.Message(appError.Code)
}</span>

func New(status int, code string, err error) AppError <span class="cov0" title="0">{
        return AppError{
                Code:   code,
                Status: status,
                Err:    err,
        }
}</span>

func (e AppError) Error() string <span class="cov0" title="0">{
        return e.Message
}</span>

func (e *AppError) RawErr() error <span class="cov0" title="0">{
        return e.Err
}</span>
</pre>
		
		<pre class="file" id="file20" style="display: none">package errcode

const (
        TPYE_ASSERTION_ERROR = "TYPE_ASSETION_ERROR"
        USER_EXIST           = "USER_EXIST"
        USER_NOT_FOUND       = "USER_NOT_FOUND"
        INVALID_TOKEN        = "INVALID_TOKEN"
        EXPIRED_TOKEN        = "EXPIRED_TOKEN"
        BAD_REQUEST          = "BAD_REQUEST"
)

var code2Message = map[string]string{
        USER_EXIST:           "使用者已存在",
        USER_NOT_FOUND:       "使用者不存在",
        INVALID_TOKEN:        "Token 驗證失敗",
        EXPIRED_TOKEN:        "Token 過期",
        BAD_REQUEST:          "輸入錯誤",
        TPYE_ASSERTION_ERROR: "內部推斷型態錯誤",
}

func Message(code string) string <span class="cov0" title="0">{

        if message, ok := code2Message[code]; ok </span><span class="cov0" title="0">{
                return message
        }</span>

        <span class="cov0" title="0">return "未定義錯誤"</span>
}
</pre>
		
		<pre class="file" id="file21" style="display: none">package basemodel

type BaseResponse struct {
        Data any `json:"data"`
}

type BaseListResponse struct {
        Total int64 `json:"total"`
        Data  any   `json:"data"`
}

type BaseQuery struct {
        Skip  int64 `form:"skip"`
        Limit int64 `form:"limit"`
}

func NewDefaultQuery() BaseQuery <span class="cov0" title="0">{
        return BaseQuery{
                Skip:  0,
                Limit: 10,
        }
}</span>
</pre>
		
		<pre class="file" id="file22" style="display: none">package auth

import (
        "context"
        "net/http"
        "time"
        "wentee/blog/app/config"
        UserRepo "wentee/blog/app/repo/user"
        "wentee/blog/app/schema/apperror"
        "wentee/blog/app/schema/apperror/errcode"
        AuthSchema "wentee/blog/app/schema/auth"
        "wentee/blog/app/utils"

        "github.com/golang-jwt/jwt/v5"
)

type AuthService struct {
        userRepo UserRepo.IGetUserByMail
}

func NewAuthService(userRepo *UserRepo.UserRepo) *AuthService <span class="cov0" title="0">{
        return &amp;AuthService{
                userRepo: userRepo,
        }
}</span>

func (authSvc *AuthService) TryLogin(ctx context.Context, loginInfo *AuthSchema.LoginInfo) (tokenString string, err error) <span class="cov0" title="0">{

        userDoc, err := authSvc.userRepo.GetUserByEmail(ctx, loginInfo.Email)

        if err != nil </span><span class="cov0" title="0">{
                return
        }</span>

        <span class="cov0" title="0">if !utils.VerifyPassword(userDoc.Password, loginInfo.Password, userDoc.Salt) </span><span class="cov0" title="0">{
                err = apperror.New(http.StatusNotFound, errcode.USER_NOT_FOUND, nil)
                return
        }</span>

        <span class="cov0" title="0">claims := AuthSchema.JWTClaims{
                UserInfo: AuthSchema.JWTUserInfo{
                        Id: userDoc.Id.Hex(),
                },
                RegisteredClaims: jwt.RegisteredClaims{
                        Issuer:    config.SERVICE_NAME,
                        ExpiresAt: jwt.NewNumericDate(time.Now().Add(7 * 24 * time.Hour)),
                },
        }

        token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims)

        tokenString, err = token.SignedString([]byte(config.JWT_SECRET))

        return</span>
}
</pre>
		
		<pre class="file" id="file23" style="display: none">package post

import (
        "context"
        PostRepo "wentee/blog/app/repo/post"
        "wentee/blog/app/schema/basemodel"
        PostSchema "wentee/blog/app/schema/post"

        "go.mongodb.org/mongo-driver/bson/primitive"
)

type PostService struct {
        postRepo PostRepo.IPostRepository
}

func NewPostService(postRepo *PostRepo.PostRepo) *PostService <span class="cov0" title="0">{
        return &amp;PostService{
                postRepo: postRepo,
        }
}</span>

func (svc *PostService) CreatePost(ctx context.Context, postCreate *PostSchema.PostCreate, createdByString string) (err error) <span class="cov0" title="0">{
        createdBy, err := primitive.ObjectIDFromHex(createdByString)
        if err != nil </span><span class="cov0" title="0">{
                return
        }</span>
        <span class="cov0" title="0">err = svc.postRepo.CreatePost(ctx, postCreate, &amp;createdBy)
        return</span>
}

func (svc *PostService) ListPosts(ctx context.Context, query *basemodel.BaseQuery) (total int64, postSlice []PostSchema.PostList, err error) <span class="cov0" title="0">{
        total, posts, err := svc.postRepo.ListPosts(ctx, query)

        postSlice = make([]PostSchema.PostList, len(posts))

        for index, post := range posts </span><span class="cov0" title="0">{
                postSlice[index] = PostSchema.PostList{
                        Id:      post.Id,
                        Title:   post.Title,
                        Creator: PostSchema.Creator{Id: post.Creator.Id, Username: post.Creator.Username},
                }
        }</span>

        <span class="cov0" title="0">return</span>
}

func (svc *PostService) GetPostById(ctx context.Context, id string) (post PostSchema.Post, err error) <span class="cov0" title="0">{
        oid, err := primitive.ObjectIDFromHex(id)

        if err != nil </span><span class="cov0" title="0">{
                return
        }</span>
        <span class="cov0" title="0">postDoc, err := svc.postRepo.GetPostById(ctx, oid)
        if err != nil </span><span class="cov0" title="0">{
                return
        }</span>
        <span class="cov0" title="0">post = PostSchema.Post{
                PostList: PostSchema.PostList{
                        Id:      postDoc.Id,
                        Title:   postDoc.Title,
                        Creator: PostSchema.Creator{Id: postDoc.Creator.Id, Username: postDoc.Creator.Username},
                },
                Content:   *postDoc.Content,
                CreatedAt: postDoc.CreatedAt,
        }
        return</span>
}

func (svc *PostService) UpdatePostById(ctx context.Context, id string, updateData *PostSchema.PostUpdate) (err error) <span class="cov0" title="0">{
        oid, err := primitive.ObjectIDFromHex(id)
        if err != nil </span><span class="cov0" title="0">{
                return
        }</span>
        <span class="cov0" title="0">err = svc.postRepo.UpdatePostById(ctx, oid, updateData)
        return</span>
}

func (svc *PostService) DeletePostById(ctx context.Context, id string) (err error) <span class="cov0" title="0">{
        oid, err := primitive.ObjectIDFromHex(id)

        if err != nil </span><span class="cov0" title="0">{
                return
        }</span>

        <span class="cov0" title="0">err = svc.postRepo.DeletePostById(ctx, oid)

        return</span>
}
</pre>
		
		<pre class="file" id="file24" style="display: none">package user

import (
        "context"
        "net/http"
        UserModel "wentee/blog/app/model/mongodb/user"
        UserRepo "wentee/blog/app/repo/user"
        "wentee/blog/app/schema/apperror"
        "wentee/blog/app/schema/apperror/errcode"
        "wentee/blog/app/schema/basemodel"
        UserSchema "wentee/blog/app/schema/user"
        "wentee/blog/app/utils"

        "go.mongodb.org/mongo-driver/bson"
        "go.mongodb.org/mongo-driver/bson/primitive"
        "go.mongodb.org/mongo-driver/mongo/options"
)

type UserService struct {
        userRepo UserRepo.IUserRepository
}

func NewUserService(userRepo *UserRepo.UserRepo) *UserService <span class="cov0" title="0">{
        return &amp;UserService{
                userRepo: userRepo,
        }
}</span>

func (svc *UserService) CountUsers(ctx context.Context) (total int64, err error) <span class="cov0" title="0">{
        return svc.userRepo.CountUsers(ctx)
}</span>

func (svc *UserService) RegistryUser(ctx context.Context, createUser *UserSchema.UserCreate) error <span class="cov0" title="0">{

        if user, _ := svc.userRepo.GetUserByEmail(ctx, createUser.Email); user != nil </span><span class="cov0" title="0">{
                return apperror.New(http.StatusBadRequest, errcode.USER_EXIST, nil)
        }</span>

        <span class="cov0" title="0">salt, err := utils.GenerateSalt(32)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">hashedPasswroed, err := utils.HashPassword(createUser.Password, salt)

        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">if err := svc.userRepo.CreateUser(ctx, &amp;UserModel.UserDocument{
                Email:    createUser.Email,
                Username: createUser.Username,
                Password: hashedPasswroed,
                Salt:     salt,
        }); err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">return nil</span>
}

func (svc *UserService) GetUserById(ctx context.Context, id string) (*UserSchema.UserInfo, error) <span class="cov0" title="0">{
        oId, err := primitive.ObjectIDFromHex(id)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">userDoc, err := svc.userRepo.GetUserById(ctx, oId, options.FindOne().SetProjection(bson.M{UserModel.FieldPassword: 0}))

        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">return &amp;UserSchema.UserInfo{
                Id:       userDoc.Id,
                Email:    userDoc.Email,
                Username: userDoc.Username,
        }, nil</span>
}

func (svc *UserService) ListUsers(ctx context.Context, baseQuery *basemodel.BaseQuery) (users []UserSchema.UserInfo, err error) <span class="cov0" title="0">{

        userDocs, err := svc.userRepo.QueryUsers(ctx, baseQuery)

        if err != nil </span><span class="cov0" title="0">{
                return
        }</span>

        <span class="cov0" title="0">for _, userDoc := range userDocs </span><span class="cov0" title="0">{
                users = append(users, UserSchema.UserInfo{
                        Id:       userDoc.Id,
                        Email:    userDoc.Email,
                        Username: userDoc.Username,
                })
        }</span>

        <span class="cov0" title="0">return</span>

}

func (svc *UserService) UpdateUserById(ctx context.Context, id string, userUpdate *UserSchema.UserUpdate) (err error) <span class="cov0" title="0">{
        oId, err := primitive.ObjectIDFromHex(id)
        if err != nil </span><span class="cov0" title="0">{
                return
        }</span>
        <span class="cov0" title="0">err = svc.userRepo.UpdateUserById(ctx, oId, userUpdate)
        return</span>
}

func (svc *UserService) DeleteUserById(ctx context.Context, id string) (err error) <span class="cov0" title="0">{
        oid, err := primitive.ObjectIDFromHex(id)
        if err != nil </span><span class="cov0" title="0">{
                return
        }</span>
        <span class="cov0" title="0">err = svc.userRepo.DeleteUserById(ctx, oid)
        return</span>
}
</pre>
		
		<pre class="file" id="file25" style="display: none">package testutils

import (
        "context"
        "wentee/blog/app/utils/mongo/imongo"

        "github.com/stretchr/testify/mock"
        "go.mongodb.org/mongo-driver/bson"
        "go.mongodb.org/mongo-driver/mongo"
        "go.mongodb.org/mongo-driver/mongo/options"
)

type MockCollection struct {
        mock.Mock
}

func appendCallArgs[T any](fixed []any, variadic []T) []any <span class="cov0" title="0">{
        out := make([]any, 0, len(fixed)+len(variadic))

        out = append(out, fixed...)

        for _, v := range variadic </span><span class="cov0" title="0">{
                out = append(out, v)
        }</span>
        <span class="cov0" title="0">return out</span>
}

func (m *MockCollection) CountDocuments(ctx context.Context, filter any, opts ...*options.CountOptions) (int64, error) <span class="cov0" title="0">{
        params := appendCallArgs([]any{ctx, filter}, opts)
        args := m.Called(params...)
        return args.Get(0).(int64), args.Error(1)
}</span>

func (m *MockCollection) Find(ctx context.Context, filter any, opts ...*options.FindOptions) (imongo.Cursor, error) <span class="cov0" title="0">{
        params := appendCallArgs([]any{ctx, filter}, opts)
        args := m.Called(params...)
        return args.Get(0).(imongo.Cursor), args.Error(1)
}</span>

func (m *MockCollection) FindOne(ctx context.Context, filter any, opts ...*options.FindOneOptions) imongo.SingleResult <span class="cov0" title="0">{
        params := appendCallArgs([]any{ctx, filter}, opts)
        args := m.Called(params...)
        return args.Get(0).(imongo.SingleResult)
}</span>

func (m *MockCollection) UpdateOne(ctx context.Context, filter any, updateDoc any, opts ...*options.UpdateOptions) (imongo.UpdateResult, error) <span class="cov0" title="0">{
        params := appendCallArgs([]any{ctx, filter, updateDoc}, opts)
        args := m.Called(params...)

        return args.Get(0).(imongo.UpdateResult), args.Error(1)
}</span>

func (m *MockCollection) DeleteOne(ctx context.Context, filter any, opts ...*options.DeleteOptions) (imongo.DeleteResult, error) <span class="cov0" title="0">{
        params := appendCallArgs([]any{ctx, filter}, opts)
        args := m.Called(params...)
        return args.Get(0).(imongo.DeleteResult), args.Error(1)
}</span>

func (m *MockCollection) InsertOne(ctx context.Context, data any, opts ...*options.InsertOneOptions) (imongo.InsertOneResult, error) <span class="cov0" title="0">{
        params := appendCallArgs([]any{ctx, data}, opts)
        args := m.Called(params...)

        return args.Get(0).(*mongo.InsertOneResult), args.Error(1)
}</span>

func (m *MockCollection) Aggregate(ctx context.Context, pipeline interface{}, opts ...*options.AggregateOptions) (imongo.Cursor, error) <span class="cov0" title="0">{
        params := appendCallArgs([]any{ctx, pipeline}, opts)
        args := m.Called(params...)
        return args.Get(0).(imongo.Cursor), args.Error(1)
}</span>

type MockCursor struct {
        mock.Mock
}

func (m *MockCursor) All(ctx context.Context, out interface{}) error <span class="cov0" title="0">{
        args := m.Called(ctx, out)
        return args.Error(0)
}</span>

func (m *MockCursor) Next(ctx context.Context) bool <span class="cov0" title="0">{
        args := m.Called(ctx)
        return args.Bool(0)
}</span>

func (m *MockCursor) Decode(v interface{}) error <span class="cov0" title="0">{
        args := m.Called(v)
        return args.Error(0)
}</span>

func (m *MockCursor) Close(ctx context.Context) error <span class="cov0" title="0">{
        args := m.Called(ctx)
        return args.Error(0)
}</span>

type MockSingleResult struct {
        mock.Mock
}

func (m *MockSingleResult) Decode(v any) error <span class="cov0" title="0">{
        args := m.Called(v)
        return args.Error(0)
}</span>

type MockMongoUtils struct {
        mock.Mock
}

// CountDocumentWithPipeline implements mongoutils.DocumentCounter.
func (m *MockMongoUtils) CountDocumentWithPipeline(ctx context.Context, aggregator imongo.IAggregate, countPipeline bson.A) (total int64, err error) <span class="cov0" title="0">{
        args := m.Called(ctx, aggregator, countPipeline)
        return args.Get(0).(int64), args.Error(1)
}</span>
</pre>
		
		<pre class="file" id="file26" style="display: none">package mongoutils

import (
        "context"
        "wentee/blog/app/utils/mongo/imongo"

        "go.mongodb.org/mongo-driver/bson"
)

type DocumentCounter interface {
        CountDocumentWithPipeline(ctx context.Context, aggregator imongo.IAggregate, countPipeline bson.A) (total int64, err error)
}

type MongoUtils struct {
}

func (m *MongoUtils) CountDocumentWithPipeline(ctx context.Context, aggregator imongo.IAggregate, countPipeline bson.A) (total int64, err error) <span class="cov0" title="0">{
        cursor, err := aggregator.Aggregate(ctx, countPipeline)

        if err != nil </span><span class="cov0" title="0">{
                return
        }</span>
        <span class="cov0" title="0">defer cursor.Close(ctx)

        var countResult []bson.M
        if err = cursor.All(ctx, &amp;countResult); err != nil </span><span class="cov0" title="0">{
                return
        }</span>

        <span class="cov0" title="0">if len(countResult) &gt; 0 </span><span class="cov0" title="0">{
                total = int64(countResult[0]["total"].(int32))
        }</span>
        <span class="cov0" title="0">return</span>
}
</pre>
		
		<pre class="file" id="file27" style="display: none">package pipefactory

import (
        "go.mongodb.org/mongo-driver/bson"
)

type PipelineBuilder struct {
        stages    bson.A
        sortStage bson.D
        skip      *int64
        limit     *int64
}

func NewPipelineBuilder() *PipelineBuilder <span class="cov0" title="0">{
        return &amp;PipelineBuilder{}
}</span>

func (pb *PipelineBuilder) AddOperations(ops ...bson.D) *PipelineBuilder <span class="cov0" title="0">{
        for _, op := range ops </span><span class="cov0" title="0">{
                pb.stages = append(pb.stages, op)
        }</span>
        <span class="cov0" title="0">return pb</span>
}

func (pb *PipelineBuilder) AddSkip(skip int64) *PipelineBuilder <span class="cov0" title="0">{
        pb.skip = &amp;skip
        return pb
}</span>

func (pb *PipelineBuilder) AddLimit(limit int64) *PipelineBuilder <span class="cov0" title="0">{
        pb.limit = &amp;limit
        return pb
}</span>

func (pb *PipelineBuilder) AddSort(sort bson.D) *PipelineBuilder <span class="cov0" title="0">{
        pb.sortStage = sort
        return pb
}</span>

func (pb *PipelineBuilder) BuildCountPipeline() bson.A <span class="cov0" title="0">{
        pipeline := bson.A{}
        pipeline = append(pipeline, pb.stages...)
        pipeline = append(pipeline, bson.D{{Key: "$count", Value: "total"}})
        return pipeline

}</span>

func (pb *PipelineBuilder) BuildQeuryPipeline() bson.A <span class="cov0" title="0">{
        pipeline := bson.A{}
        pipeline = append(pipeline, pb.stages...)

        if len(pb.sortStage) &gt; 0 </span><span class="cov0" title="0">{
                pipeline = append(pipeline, bson.D{{Key: "$sort", Value: pb.sortStage}})
        }</span>
        <span class="cov0" title="0">if pb.skip != nil </span><span class="cov0" title="0">{
                pipeline = append(pipeline, bson.D{{Key: "$skip", Value: *pb.skip}})
        }</span>
        <span class="cov0" title="0">if pb.limit != nil </span><span class="cov0" title="0">{
                pipeline = append(pipeline, bson.D{{Key: "$limit", Value: *pb.limit}})
        }</span>

        <span class="cov0" title="0">return pipeline</span>
}
</pre>
		
		<pre class="file" id="file28" style="display: none">package reqcontext

import (
        "net/http"
        "wentee/blog/app/schema/apperror"
        "wentee/blog/app/schema/apperror/errcode"
        "wentee/blog/app/schema/auth"
        AuthSchema "wentee/blog/app/schema/auth"

        "github.com/gin-gonic/gin"
)

const USER_INFO = "UserInfo"

func GetUserInfo(c *gin.Context) (userInfo AuthSchema.JWTUserInfo, err error) <span class="cov0" title="0">{
        userInfoAny, ok := c.Get(USER_INFO)
        if !ok </span><span class="cov0" title="0">{
                err = apperror.New(http.StatusBadRequest, errcode.USER_NOT_FOUND, nil)
                return
        }</span>
        <span class="cov0" title="0">userInfo, ok = userInfoAny.(auth.JWTUserInfo)
        if !ok </span><span class="cov0" title="0">{
                err = apperror.New(http.StatusInternalServerError, errcode.TPYE_ASSERTION_ERROR, nil)
                return
        }</span>
        <span class="cov0" title="0">return</span>
}
</pre>
		
		<pre class="file" id="file29" style="display: none">package utils

import (
        "crypto/rand"
        "encoding/hex"

        "golang.org/x/crypto/bcrypt"
)

func GenerateSalt(length int) (string, error) <span class="cov0" title="0">{
        placeBytes := make([]byte, length)

        if _, err := rand.Read(placeBytes); err != nil </span><span class="cov0" title="0">{
                return "", err
        }</span>

        <span class="cov0" title="0">return hex.EncodeToString(placeBytes), nil</span>
}

func HashPassword(password string, salt string) (string, error) <span class="cov0" title="0">{
        salted := password + salt
        hashBytes, err := bcrypt.GenerateFromPassword([]byte(salted), bcrypt.DefaultCost)

        return string(hashBytes), err
}</span>

func VerifyPassword(hashedPassword string, password string, salt string) bool <span class="cov0" title="0">{
        salted := password + salt

        if err := bcrypt.CompareHashAndPassword([]byte(hashedPassword), []byte(salted)); err != nil </span><span class="cov0" title="0">{
                return false
        }</span>
        <span class="cov0" title="0">return true</span>
}
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
